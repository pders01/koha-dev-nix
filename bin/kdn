#!/bin/bash

# kdn - koha-dev-nix management script
#
# A wrapper for managing the Koha Nix development environment
# for PerlNavigator LSP support.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Defaults - reuse SYNC_REPO from ktd if available
KOHA_SRC="${KOHA_SRC:-$SYNC_REPO}"
KOHA_BRANCH=""
NIX_FLAGS="--extra-experimental-features nix-command --extra-experimental-features flakes"

usage() {
    echo ""
    echo -e "${BOLD}kdn${NC} - Koha Development Nix environment manager"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "    kdn [options] <command>"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "    shell               Enter the Nix development shell"
    echo "    test                Run full module test (1245 modules)"
    echo "    check <Module>      Test if a specific module loads"
    echo "    stubs               List all stub modules"
    echo "    missing             Find missing external dependencies"
    echo "    code                Open VS Code in the Koha directory"
    echo "    nvim                Open Neovim in the Koha directory"
    echo "    zed                 Open Zed in the Koha directory"
    echo "    status              Show environment status"
    echo "    help                Show this help message"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "    --branch <branch>   Use specific Koha branch (main, 25.11, 25.05, 24.11)"
    echo "    --koha-src <path>   Path to Koha source (default: ../koha relative to KDN_HOME)"
    echo "    --help, -h          Show this help message"
    echo ""
    echo -e "${BOLD}Environment variables:${NC}"
    echo "    KDN_HOME            Path to koha-dev-nix clone (required)"
    echo "    KOHA_SRC            Path to Koha source (required, or use SYNC_REPO)"
    echo "    SYNC_REPO           Alternative to KOHA_SRC (for ktd users)"
    echo "    KOHA_BRANCH         Default branch to use"
    echo ""
    echo -e "${BOLD}Supported branches:${NC}"
    echo "    main                Main development branch"
    echo "    25.11               Upcoming release (November 2025)"
    echo "    25.05               Current stable (May 2025)"
    echo "    24.11               Previous stable (November 2024)"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "    kdn shell                      # Enter dev shell with current branch"
    echo "    kdn --branch 24.11 shell       # Enter dev shell, checkout 24.11"
    echo "    kdn test                       # Run full module test"
    echo "    kdn check C4::Biblio           # Test specific module"
    echo "    kdn code                       # Open VS Code"
    echo "    kdn nvim                       # Open Neovim"
    echo "    kdn zed                        # Open Zed"
    echo ""
}

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

info() {
    echo -e "${BLUE}$1${NC}"
}

success() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}$1${NC}"
}

check_requirements() {
    if ! command -v nix &> /dev/null; then
        error "Nix is not installed. Visit https://nixos.org/download.html"
    fi

    if [ -z "$KDN_HOME" ]; then
        error "KDN_HOME is not set.\nAdd to your shell profile: export KDN_HOME=/path/to/koha-dev-nix"
    fi

    if [ ! -d "$KDN_HOME" ]; then
        error "KDN_HOME ($KDN_HOME) does not exist"
    fi

    if [ ! -f "$KDN_HOME/flake.nix" ]; then
        error "flake.nix not found in $KDN_HOME"
    fi

    if [ -z "$KOHA_SRC" ]; then
        error "KOHA_SRC (or SYNC_REPO) is not set.\nAdd to your shell profile: export KOHA_SRC=/path/to/koha"
    fi

    if [ ! -d "$KOHA_SRC" ]; then
        error "Koha source not found at $KOHA_SRC"
    fi
}

switch_branch() {
    local branch="$1"

    if [ -z "$branch" ]; then
        return 0
    fi

    # Validate branch
    case "$branch" in
        main|25.11|25.05|24.11)
            ;;
        *)
            error "Unknown branch: $branch\nSupported: main, 25.11, 25.05, 24.11"
            ;;
    esac

    info "Switching Koha to branch: $branch"

    cd "$KOHA_SRC"

    # Check for uncommitted changes
    if ! git diff --quiet HEAD 2>/dev/null; then
        warn "Warning: Koha has uncommitted changes"
        read -p "Continue anyway? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    # Fetch and checkout
    git fetch origin "$branch" 2>/dev/null || error "Failed to fetch branch $branch"
    git checkout "$branch" 2>/dev/null || error "Failed to checkout branch $branch"
    git pull --ff-only 2>/dev/null || warn "Could not fast-forward (might be on local branch)"

    success "Now on branch: $(git branch --show-current)"
}

cmd_shell() {
    check_requirements
    switch_branch "$KOHA_BRANCH"

    info "Entering Koha dev shell..."
    cd "$KDN_HOME"
    exec nix develop $NIX_FLAGS
}

cmd_test() {
    check_requirements

    info "Running full module test..."
    cd "$KDN_HOME"
    nix develop $NIX_FLAGS -c perl test_all_modules.pl
}

cmd_check() {
    local module="$1"

    if [ -z "$module" ]; then
        error "Usage: kdn check <Module::Name>\nExample: kdn check C4::Biblio"
    fi

    check_requirements

    info "Testing $module..."
    cd "$KDN_HOME"

    local output
    output=$(nix develop $NIX_FLAGS -c perl -I"$KDN_HOME/stubs" -I"$KOHA_SRC" -e "use $module; print \"OK\n\"" 2>&1)
    local exit_code=$?

    if [ $exit_code -eq 0 ]; then
        success "OK: $module loaded successfully"
    else
        echo -e "${RED}FAILED${NC}: $module could not be loaded"
        echo "$output" | grep -v "unable to locate Koha configuration" | grep -v "^Use of uninitialized value" | head -10
        return 1
    fi
}

cmd_stubs() {
    check_requirements

    echo -e "${BOLD}Stub modules in $KDN_HOME/stubs/:${NC}"
    find "$KDN_HOME/stubs" -name "*.pm" | sed "s|$KDN_HOME/stubs/||" | sed 's|/|::|g' | sed 's|\.pm$||' | sort
}

cmd_missing() {
    check_requirements

    info "Finding missing dependencies..."
    cd "$KDN_HOME"
    nix develop $NIX_FLAGS -c perl find_missing.pl
}

cmd_code() {
    check_requirements

    info "Opening VS Code in Koha directory..."
    cd "$KDN_HOME"
    nix develop $NIX_FLAGS -c code "$KOHA_SRC"
}

cmd_nvim() {
    check_requirements

    info "Opening Neovim in Koha directory..."
    cd "$KDN_HOME"
    nix develop $NIX_FLAGS -c nvim "$KOHA_SRC"
}

cmd_zed() {
    check_requirements

    info "Opening Zed in Koha directory..."
    cd "$KDN_HOME"
    nix develop $NIX_FLAGS -c zed "$KOHA_SRC"
}

cmd_status() {
    check_requirements

    echo -e "${CYAN}╭─────────────────────────────────────────────╮${NC}"
    echo -e "${CYAN}│${NC}  ${BOLD}Koha Development Nix Environment${NC}          ${CYAN}│${NC}"
    echo -e "${CYAN}╰─────────────────────────────────────────────╯${NC}"
    echo
    echo -e "${BOLD}Paths:${NC}"
    echo "  KDN_HOME:  $KDN_HOME"
    echo "  KOHA_SRC:  $KOHA_SRC"
    echo

    if [ -d "$KOHA_SRC/.git" ]; then
        cd "$KOHA_SRC"
        echo -e "${BOLD}Koha:${NC}"
        echo "  Branch:    $(git branch --show-current 2>/dev/null || echo 'unknown')"
        echo "  Commit:    $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

        if ! git diff --quiet HEAD 2>/dev/null; then
            echo -e "  Status:    ${YELLOW}uncommitted changes${NC}"
        else
            echo -e "  Status:    ${GREEN}clean${NC}"
        fi
    fi
    echo
    echo -e "${BOLD}Module coverage:${NC} ${GREEN}1243/1245 (99.8%)${NC}"
    echo
}

# Parse command line
COMMAND=""
COMMAND_ARG=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help|help)
            usage
            exit 0
            ;;
        --branch)
            if [ -z "$2" ] || [[ "$2" == -* ]]; then
                error "--branch requires an argument"
            fi
            KOHA_BRANCH="$2"
            shift 2
            ;;
        --koha-src)
            if [ -z "$2" ] || [[ "$2" == -* ]]; then
                error "--koha-src requires a path argument"
            fi
            KOHA_SRC="$2"
            shift 2
            ;;
        shell|test|stubs|missing|code|nvim|zed|status)
            COMMAND="$1"
            shift
            ;;
        check)
            COMMAND="check"
            shift
            if [ $# -eq 0 ] || [[ "$1" == -* ]]; then
                error "check requires a module name\nUsage: kdn check <Module::Name>"
            fi
            COMMAND_ARG="$1"
            shift
            ;;
        *)
            error "Unknown command: $1\nRun 'kdn help' for usage"
            ;;
    esac
done

# Execute command
case "$COMMAND" in
    shell)
        cmd_shell
        ;;
    test)
        cmd_test
        ;;
    check)
        cmd_check "$COMMAND_ARG"
        ;;
    stubs)
        cmd_stubs
        ;;
    missing)
        cmd_missing
        ;;
    code)
        cmd_code
        ;;
    nvim)
        cmd_nvim
        ;;
    zed)
        cmd_zed
        ;;
    status)
        cmd_status
        ;;
    "")
        usage
        exit 0
        ;;
esac
